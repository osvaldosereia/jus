<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Simulador de Provas de Concurso</title>
    <!-- Carrega o Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Carrega a fonte Inter (estilo Apple) -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

    <style>
        /* Estilo minimalista (Apple) */
        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }

        /* Estilos para as alternativas respondidas */
        .alternativa-item.correct {
            background-color: #D1FAE5; /* Tailwind green-100 */
            border-color: #34D399; /* Tailwind green-400 */
            color: #065F46; /* Tailwind green-800 */
            font-weight: 500;
        }
        .alternativa-item.wrong {
            background-color: #FEE2E2; /* Tailwind red-100 */
            border-color: #F87171; /* Tailwind red-400 */
            color: #991B1B; /* Tailwind red-800 */
            font-weight: 500;
        }
        
        /* Estilo para a alternativa correta (quando o usuário erra) */
        .alternativa-item.gabarito-correto {
             background-color: #D1FAE5; /* Tailwind green-100 */
             border-color: #34D399; /* Tailwind green-400 */
        }
        
        /* Oculta os spinners de inputs numéricos (embora não estejamos usando, é bom ter) */
        input[type='number']::-webkit-inner-spin-button,
        input[type='number']::-webkit-outer-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }
    </style>
</head>
<body class="bg-gray-100">

    <div class="max-w-4xl mx-auto p-4 md:p-8">
        
        <!-- Cabeçalho -->
        <header class="text-center mb-6">
            <h1 class="text-3xl font-bold text-gray-800">Simulador de Provas</h1>
        </header>

        <!-- Controles de Seleção -->
        <section class="mb-6 p-6 bg-white rounded-lg shadow-sm">
            <div class="flex flex-col sm:flex-row gap-4 items-center">
                <!-- Dropdown Disciplina -->
                <div class="w-full sm:w-1/3">
                    <label for="selectDisciplina" class="block text-sm font-medium text-gray-700 mb-1">Disciplina</label>
                    <select id="selectDisciplina" class="w-full p-3 border border-gray-300 rounded-md bg-gray-50 focus:ring-2 focus:ring-blue-500 focus:outline-none">
                        <!-- Opções carregadas via JS -->
                    </select>
                </div>
                
                <!-- Dropdown Tema -->
                <div class="w-full sm:w-1/3">
                    <label for="selectTema" class="block text-sm font-medium text-gray-700 mb-1">Tema</label>
                    <select id="selectTema" class="w-full p-3 border border-gray-300 rounded-md bg-gray-50 focus:ring-2 focus:ring-blue-500 focus:outline-none">
                        <!-- Opções carregadas via JS -->
                    </select>
                </div>

                <!-- Botão Carregar/Trocar -->
                <div class="w-full sm:w-1/3 sm:mt-6">
                    <button id="btnCarregarProva" class="w-full px-6 py-3 font-semibold text-white rounded-md transition-all duration-300 bg-blue-600 hover:bg-blue-700 shadow-sm">
                        Carregar Prova
                    </button>
                </div>
            </div>
        </section>

        <!-- Área da Prova -->
        <main id="areaProva">
            <!-- Status (Carregando, Erro, etc.) -->
            <div id="divStatus" class="text-center text-gray-600 p-10 text-lg">
                Selecione a disciplina e o tema para começar.
            </div>

            <!-- Container das Questões -->
            <div id="divQuestoes" class="space-y-6">
                <!-- As questões serão inseridas aqui via JS -->
            </div>
        </main>

    </div>

    <script type="module">
        // --- 1. Definição do "Banco de Dados" de Disciplinas e Temas ---
        
        // Esta estrutura define quais pastas o sistema irá procurar.
        // A chave (ex: "direito-penal") é o nome da pasta.
        // O valor (ex: "Direito Penal") é o nome exibido.
        const dbDisciplinas = {
            "direito-penal": {
                nome: "Direito Penal",
                temas: {
                    "calunia": "Calúnia",
                    "difamacao": "Difamação",
                    "homicidio": "Homicídio"
                }
            },
            "direito-civil": {
                nome: "Direito Civil",
                temas: {
                    "contratos": "Contratos",
                    "obrigacoes": "Obrigações",
                    "posse": "Posse e Propriedade"
                }
            },
            "portugues": {
                nome: "Português",
                temas: {
                    "concordancia": "Concordância",
                    "crase": "Crase"
                }
            }
        };

        // --- 2. Referências aos Elementos do DOM ---
        
        const selectDisciplina = document.getElementById('selectDisciplina');
        const selectTema = document.getElementById('selectTema');
        const btnCarregarProva = document.getElementById('btnCarregarProva');
        const divStatus = document.getElementById('divStatus');
        const divQuestoes = document.getElementById('divQuestoes');

        // --- 3. Estado da Aplicação ---
        
        let provaCarregada = false;

        // --- 4. Funções Principais ---

        /**
         * Inicializa o simulador ao carregar a página.
         */
        function init() {
            popularDisciplinas();
            // Adiciona os listeners de eventos
            selectDisciplina.addEventListener('change', () => {
                popularTemas();
                resetarEstadoProva();
            });
            selectTema.addEventListener('change', resetarEstadoProva);
            btnCarregarProva.addEventListener('click', () => {
                // Se a prova já estiver carregada, o botão funciona como "Trocar"
                if (provaCarregada) {
                    resetarProvaCompleta();
                } else {
                    carregarProva();
                }
            });
        }

        /**
         * Popula o dropdown de Disciplinas com base no dbDisciplinas.
         */
        function popularDisciplinas() {
            selectDisciplina.innerHTML = ''; // Limpa opções anteriores
            for (const [chave, valor] of Object.entries(dbDisciplinas)) {
                const option = new Option(valor.nome, chave);
                selectDisciplina.add(option);
            }
            // Carrega os temas da primeira disciplina selecionada
            popularTemas();
        }

        /**
         * Popula o dropdown de Temas com base na disciplina selecionada.
         */
        function popularTemas() {
            const disciplinaKey = selectDisciplina.value;
            const temas = dbDisciplinas[disciplinaKey]?.temas || {};
            
            selectTema.innerHTML = ''; // Limpa opções anteriores
            for (const [chave, valor] of Object.entries(temas)) {
                const option = new Option(valor, chave);
                selectTema.add(option);
            }
        }

        /**
         * Reseta o estado do botão "Carregar Prova" se uma prova estava carregada.
         * Chamado quando o usuário muda um dropdown.
         */
        function resetarEstadoProva() {
            if (provaCarregada) {
                btnCarregarProva.textContent = 'Carregar Prova';
                btnCarregarProva.classList.remove('bg-gray-600', 'hover:bg-gray-700');
                btnCarregarProva.classList.add('bg-blue-600', 'hover:bg-blue-700');
                provaCarregada = false;
                divStatus.textContent = 'Seleção alterada. Clique em "Carregar Prova".';
                divStatus.classList.remove('hidden');
            }
        }
        
        /**
         * Reseta a prova inteira (limpa questões) e volta ao estado inicial.
         * Chamado quando o usuário clica em "Trocar Prova".
         */
        function resetarProvaCompleta() {
            divQuestoes.innerHTML = '';
            divStatus.textContent = 'Selecione a disciplina e o tema para começar.';
            divStatus.classList.remove('hidden');
            resetarEstadoProva(); // Reseta o botão
        }

        /**
         * Busca o arquivo JSON e exibe a prova.
         */
        async function carregarProva() {
            const disciplinaKey = selectDisciplina.value;
            const temaKey = selectTema.value;

            // Escolhe aleatoriamente uma prova de p1.json a p10.json
            const provaNum = Math.floor(Math.random() * 10) + 1;
            const url = `data/${disciplinaKey}/${temaKey}/p${provaNum}.json`;

            console.log(`Tentando carregar: ${url}`);
            
            // Atualiza UI para estado de carregamento
            divQuestoes.innerHTML = '';
            divStatus.textContent = 'Carregando prova...';
            divStatus.classList.remove('hidden');
            btnCarregarProva.disabled = true;

            try {
                const response = await fetch(url);
                if (!response.ok) {
                    throw new Error(`Arquivo não encontrado ou erro na rede (Status: ${response.status})`);
                }
                
                // O JSON deve ser um array de questões
                const questoes = await response.json(); 
                
                if (!Array.isArray(questoes) || questoes.length === 0) {
                     throw new Error("O arquivo JSON está vazio ou em formato inválido.");
                }

                exibirProva(questoes.slice(0, 20)); // Limita a 20 questões

                // Sucesso
                divStatus.classList.add('hidden');
                btnCarregarProva.textContent = 'Trocar Prova';
                btnCarregarProva.classList.remove('bg-blue-600', 'hover:bg-blue-700');
                btnCarregarProva.classList.add('bg-gray-600', 'hover:bg-gray-700');
                provaCarregada = true;

            } catch (error) {
                console.error("Erro ao carregar prova:", error);
                divStatus.innerHTML = `
                    <p class="font-semibold text-red-600">Erro ao carregar a prova.</p>
                    <p class="text-sm text-gray-500 mt-2">Não foi possível encontrar o arquivo: <strong>${url}</strong></p>
                    <p class="text-sm text-gray-500 mt-1"><strong>Lembre-se:</strong> O preview não funciona. Você precisa hospedar os arquivos (ex: GitHub Pages) para que o simulador possa carregar os dados.</p>
                `;
            } finally {
                btnCarregarProva.disabled = false;
            }
        }

        /**
         * Renderiza as questões na tela.
         * @param {Array} questoes - Um array de objetos de questão.
         */
        function exibirProva(questoes) {
            divQuestoes.innerHTML = ''; // Limpa
            questoes.forEach((questao, index) => {
                const elementoQuestao = criarElementoQuestao(questao, index + 1);
                divQuestoes.appendChild(elementoQuestao);
                
                // Adiciona separador (exceto após a última questão)
                if (index < questoes.length - 1) {
                    const separador = document.createElement('hr');
                    separador.className = 'my-8 border-t border-gray-200';
                    divQuestoes.appendChild(separador);
                }
            });
        }

        /**
         * Cria o HTML para uma única questão.
         * @param {object} questao - O objeto da questão.
         * @param {number} numero - O número da questão (ex: 1, 2, 3...).
         * @returns {HTMLElement} - O elemento <div> do card da questão.
         */
        function criarElementoQuestao(questao, numero) {
            const card = document.createElement('div');
            card.className = 'bg-white p-6 rounded-lg shadow-md';
            card.dataset.id = questao.id || `q${numero}`;
            
            // 1. Metadados
            const metadata = document.createElement('p');
            metadata.className = 'text-xs text-gray-500 mb-3';
            metadata.textContent = `Questão ${numero} | ${questao.metadata || 'Sem metadados'}`;
            card.appendChild(metadata);

            // 2. Enunciado
            const enunciado = document.createElement('p');
            enunciado.className = 'text-base md:text-lg text-gray-800 mb-5 leading-relaxed';
            enunciado.textContent = questao.enunciado;
            card.appendChild(enunciado);

            // 3. Alternativas
            const alternativasContainer = document.createElement('div');
            alternativasContainer.className = 'space-y-3';
            
            (questao.alternativas || []).forEach(alt => {
                const altItem = document.createElement('div');
                altItem.className = 'alternativa-item flex items-center p-3 border border-gray-300 rounded-lg cursor-pointer transition-all duration-200 hover:bg-gray-50';
                // Usamos ml-4 para o recuo pedido
                altItem.style.marginLeft = '1rem'; 
                altItem.dataset.letra = alt.letra;
                
                altItem.innerHTML = `
                    <span class="font-semibold text-blue-600 w-6">${alt.letra})</span>
                    <span class="ml-2 text-gray-700">${alt.texto}</span>
                `;
                
                // Adiciona o listener para verificar a resposta
                altItem.addEventListener('click', () => {
                    verificarResposta(card, altItem, questao.gabarito);
                });
                
                alternativasContainer.appendChild(altItem);
            });
            card.appendChild(alternativasContainer);

            // 4. Gabarito (Oculto)
            const gabaritoDisplay = document.createElement('div');
            gabaritoDisplay.className = 'gabarito-oculto hidden mt-4 p-3 bg-blue-50 border border-blue-200 text-blue-800 rounded-md font-medium';
            gabaritoDisplay.textContent = `Gabarito: ${questao.gabarito}`;
            card.appendChild(gabaritoDisplay);

            // 5. Botões da IA
            const aiButtonsContainer = document.createElement('div');
            aiButtonsContainer.className = 'mt-5 pt-4 border-t border-gray-100 flex flex-wrap gap-2';
            
            const promptsAI = [
                { texto: "Explicar", tipo: "explicar" },
                { texto: "Analisar Incorretas", tipo: "analisar_incorretas" },
                { texto: "Resumir Conceito", tipo: "resumir" },
                { texto: "Caso Prático", tipo: "exemplo" }
            ];

            promptsAI.forEach(prompt => {
                const btn = document.createElement('button');
                btn.className = 'px-3 py-1 text-xs bg-gray-200 text-gray-700 rounded-full hover:bg-gray-300 transition-colors focus:outline-none focus:ring-2 focus:ring-blue-400';
                btn.textContent = prompt.texto;
                btn.onclick = () => abrirGoogleIA(questao, prompt.tipo);
                aiButtonsContainer.appendChild(btn);
            });
            card.appendChild(aiButtonsContainer);

            return card;
        }

        /**
         * Processa a resposta do usuário.
         * @param {HTMLElement} card - O elemento do card da questão.
         * @param {HTMLElement} alternativaSelecionada - O elemento da alternativa clicada.
         * @param {string} gabarito - A letra correta (ex: "A").
         */
        function verificarResposta(card, alternativaSelecionada, gabarito) {
            // Impede de responder duas vezes
            if (card.dataset.respondida) return; 
            card.dataset.respondida = 'true';

            const letraSelecionada = alternativaSelecionada.dataset.letra;
            const gabaritoDisplay = card.querySelector('.gabarito-oculto');
            
            if (letraSelecionada === gabarito) {
                // Resposta Correta
                alternativaSelecionada.classList.add('correct');
                gabaritoDisplay.classList.replace('bg-blue-50', 'bg-green-50');
                gabaritoDisplay.classList.replace('border-blue-200', 'border-green-200');
                gabaritoDisplay.classList.replace('text-blue-800', 'text-green-800');
                
            } else {
                // Resposta Incorreta
                alternativaSelecionada.classList.add('wrong');
                // Destaca a correta
                const altCorreta = card.querySelector(`.alternativa-item[data-letra="${gabarito}"]`);
                if (altCorreta) {
                    altCorreta.classList.add('gabarito-correto'); 
                }
                
                gabaritoDisplay.classList.replace('bg-blue-50', 'bg-red-50');
                gabaritoDisplay.classList.replace('border-blue-200', 'border-red-200');
                gabaritoDisplay.classList.replace('text-blue-800', 'text-red-800');
            }

            // Revela o gabarito
            gabaritoDisplay.classList.remove('hidden');
        }

        /**
         * Abre uma nova aba do Google (modo IA) com um prompt personalizado.
         * @param {object} questao - O objeto da questão.
         * @param {string} tipoPrompt - O tipo de prompt (ex: "explicar").
         */
        function abrirGoogleIA(questao, tipoPrompt) {
            // 1. Monta o contexto da questão
            let contexto = `Analise a seguinte questão de concurso:\n\nEnunciado: ${questao.enunciado}\n\nAlternativas:\n`;
            (questao.alternativas || []).forEach(alt => {
                contexto += `${alt.letra}) ${alt.texto}\n`;
            });
            contexto += `\nGabarito Correto: ${questao.gabarito}\n\n`;

            // 2. Define o prompt base
            let promptBase = "";
            switch (tipoPrompt) {
                case "explicar":
                    promptBase = "Explique detalhadamente por que o gabarito está correto, analisando o enunciado e a alternativa correta.";
                    break;
                case "analisar_incorretas":
                    promptBase = "Analise cada uma das alternativas INCORRETAS e explique o erro em cada uma delas.";
                    break;
                case "resumir":
                    promptBase = "Resuma o conceito jurídico ou o tema principal abordado nesta questão em 3 frases.";
                    break;
                case "exemplo":
                    promptBase = "Crie um caso prático ou um exemplo diferente que ilustre o mesmo conceito desta questão.";
                    break;
                default:
                    promptBase = "Analise a questão e forneça um estudo completo sobre ela.";
            }
            
            // 3. Monta e codifica o prompt final
            const promptCompleto = `${promptBase}\n\n${contexto}`;
            const urlQuery = encodeURIComponent(promptCompleto);
            
            // 4. Abre o Google
            // Usar /search?q= é o método mais universal. O Google decidirá se mostra a IA.
            const googleUrl = `https://www.google.com/search?q=${urlQuery}`;
            
            window.open(googleUrl, '_blank');
        }

        // --- 5. Inicialização ---
        
        // Espera o DOM estar pronto e inicializa
        document.addEventListener('DOMContentLoaded', init);

    </script>
</body>
</html>
